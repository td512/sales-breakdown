<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item dropdown show">
        <a href="#" id="yearMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="nav-link dropdown-toggle">Analytics Year</a>
        <ul id="yearDropdown" class="dropdown-menu border-0 shadow" style="left: 0px; right: inherit;">

        </ul>
      </li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <div id="activityIndicator" class="spinner-border text-primary d-none" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="/" class="brand-link">
      <img src="/img/AdminLTELogo.png"
           alt="AdminLTE Logo"
           class="brand-image img-circle elevation-3"
           style="opacity: .8">
      <span class="brand-text font-weight-light">Store Analytics</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">

      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
          <li class="nav-item has-treeview">
            <a href="" class="nav-link">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>
                Dashboard
              </p>
            </a>
          </li>
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Store Analytics</h1>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <h5 class="mb-2">Quick Overview - <span class="titleYear">
          <div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </span></h5>
        <div class="row">
          <div class="col-md-3 col-sm-6 col-12">
            <div class="info-box">
              <span class="info-box-icon bg-info"><i class="fas fa-shopping-cart"></i></span>

              <div class="info-box-content">
                <span class="info-box-text">Sale Value</span>
                <span class="info-box-number" id="saleValue">
                  <div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                </span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->
          <div class="col-md-3 col-sm-6 col-12">
            <div class="info-box">
              <span class="info-box-icon bg-success"><i class="fas fa-dollar-sign"></i></span>

              <div class="info-box-content">
                <span class="info-box-text">Profit</span>
                <span class="info-box-number" id="profitValue">
                  <div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                </span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->
          <div class="col-md-3 col-sm-6 col-12">
            <div class="info-box">
              <span class="info-box-icon bg-warning"><i class="fas fa-dollar-sign"></i></span>

              <div class="info-box-content">
                <span class="info-box-text">Tax Collected</span>
                <span class="info-box-number" id="taxValue">
                  <div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                </span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->
          <div class="col-md-3 col-sm-6 col-12">
            <div class="info-box">
              <span class="info-box-icon bg-info"><i class="fas fa-shopping-bag"></i></span>

              <div class="info-box-content">
                <span class="info-box-text">Items Sold</span>
                <span class="info-box-number" id="itemValue">
                  <div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                </span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->

        <!-- =========================================================== -->

        <!-- Small Box (Stat card) -->
        <h5 class="mb-2 mt-4">Full Analytics for <span class="titleYear">
          <div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </span></h5>

        <!-- =========================================================== -->

        <div class="row">
          <div class="col-md-6">
            <div class="card card-outline card-info">
              <div class="card-header">
                <h3 class="card-title">Sales for <span class="titleLastYear"></span>/<span class="titleYear"></span></h3>

                <div class="card-tools">
                  <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
                  </button>
                  <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div class="card-body graphs">
                <div class="chart">
                  <canvas id="saleChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>

              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!-- /.col -->
          <div class="col-md-6">
            <div class="card card-outline card-success">
              <div class="card-header">
                <h3 class="card-title">Profits for <span class="titleLastYear"></span>/<span class="titleYear"></span></h3>

                <div class="card-tools">
                  <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
                  </button>
                  <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div class="card-body graphs">
                <div class="chart">
                  <canvas id="profitChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->

        <!-- =========================================================== -->

        <div class="row">
          <div class="col-md-6">
            <div class="card card-outline card-warning">
              <div class="card-header">
                <h3 class="card-title">Tax collected for <span class="titleLastYear"></span>/<span class="titleYear"></span></h3>

                <div class="card-tools">
                  <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
                  </button>
                  <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div class="card-body">
                <div class="chart">
                  <canvas id="taxChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!-- /.col -->
          <div class="col-md-6">
            <div class="card card-outline card-info">
              <div class="card-header">
                <h3 class="card-title">Items sold for <span class="titleLastYear"></span>/<span class="titleYear"></span></h3>

                <div class="card-tools">
                  <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
                  </button>
                  <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div class="card-body graphs">
                <div class="chart">
                  <canvas id="itemChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->

  </div>
  <!-- /.content-wrapper -->

  <footer class="main-footer">
    <div class="float-right d-none d-sm-block">
      <b>Version</b> 3.0.5
    </div>
    <strong>Copyright &copy; 2020 Theo Morra &raquo; Theme &copy; 2014-2019 <a href="http://adminlte.io">AdminLTE.io</a> &laquo;</strong> All rights
    reserved.
  </footer>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/Chart.min.js"></script>
<script>
    $(function() {
        setUpEnvironment()
    })

    function setUpEnvironment(year){

        $('#yearMenu').addClass('d-none')
        $('#saleValue').empty().append('<div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status"><span class="sr-only">Loading...</span></div>')
        $('#profitValue').empty().append('<div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status"><span class="sr-only">Loading...</span></div>')
        $('#taxValue').empty().append('<div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status"><span class="sr-only">Loading...</span></div>')
        $('#itemValue').empty().append('<div id="activityIndicator" class="spinner-border spinner-border-sm text-primary" role="status"><span class="sr-only">Loading...</span></div>')
        $('#yearDropdown').empty()
        clearCanvas('saleChart')
        clearCanvas('profitChart')
        clearCanvas('taxChart')
        clearCanvas('itemChart')

        $('#activityIndicator').removeClass('d-none')
        $.get('/api/v1/transactions', function(txdata){
            Object.keys(txdata.transactionsByYear).forEach(function(key) {
                $('<li><a href="javascript:void(0)" class="yearSwitcher dropdown-item" data-year="'+key+'" class="dropdown-item">'+key+'</a></li>')
                    .appendTo('#yearDropdown')
            })

            $('#yearMenu').removeClass('d-none')
            if (year){
                $('.titleLastYear').text(year - 1)
                $('.titleYear').text(year)
            } else {
                $('.titleLastYear').text(Object.keys(txdata.transactionsByYear).pop() - 1)
                $('.titleYear').text(Object.keys(txdata.transactionsByYear).pop())
            }

            $.get('/api/v1/transactions/' + (year === undefined ?  Object.keys(txdata.transactionsByYear).pop() + '-01-01' : year + '-01-01'),
                function(data){
                    let saleValue  = 0,
                        profitValue = 0,
                        taxValue   = 0,
                        itemValue  = 0,
                        saleDataBefore   = [],
                        profitDataBefore  = [],
                        taxDataBefore    = [],
                        itemDataBefore   = [],
                        saleDataAfter   = [],
                        profitDataAfter  = [],
                        taxDataAfter    = [],
                        itemDataAfter   = []

                    Object.keys(data.currentSalesTransactionValueByMonth).forEach(function(key) {
                        saleValue += parseFloat(data.currentSalesTransactionValueByMonth[key])
                        saleDataAfter.push(parseInt(data.currentSalesTransactionValueByMonth[key]))
                    })

                    Object.keys(data.currentProfitTransactionValueByMonth).forEach(function(key) {
                        profitValue += parseFloat(data.currentProfitTransactionValueByMonth[key])
                        profitDataAfter.push(data.currentProfitTransactionValueByMonth[key])
                    })

                    Object.keys(data.currentTaxTransactionValueByMonth).forEach(function(key) {
                        taxValue += parseFloat(data.currentTaxTransactionValueByMonth[key])
                        taxDataAfter.push(data.currentTaxTransactionValueByMonth[key])
                    })

                    Object.keys(data.currentSalesTransactionsByMonth).forEach(function(key) {
                        itemValue += parseFloat(data.currentSalesTransactionsByMonth[key])
                        itemDataAfter.push(data.currentSalesTransactionsByMonth[key])
                    })

                    Object.keys(data.previousSalesTransactionValueByMonth).forEach(function(key) {
                        saleDataBefore.push(parseInt(data.previousSalesTransactionValueByMonth[key]))
                    })

                    Object.keys(data.previousProfitTransactionValueByMonth).forEach(function(key) {
                        profitDataBefore.push(data.previousProfitTransactionValueByMonth[key])
                    })

                    Object.keys(data.previousTaxTransactionValueByMonth).forEach(function(key) {
                        taxDataBefore.push(data.previousTaxTransactionValueByMonth[key])
                    })

                    Object.keys(data.previousSalesTransactionsByMonth).forEach(function(key) {
                        itemDataBefore.push(data.previousSalesTransactionsByMonth[key])
                    })

                    $('#saleValue').text(data.currency_symbol + Math.round((saleValue + Number.EPSILON) * 100) / 100)
                    $('#profitValue').text(data.currency_symbol + Math.round((profitValue + Number.EPSILON) * 100) / 100)
                    $('#taxValue').text(data.currency_symbol + Math.round((taxValue + Number.EPSILON) * 100) / 100)
                    $('#itemValue').text(itemValue)

                    drawChart('#saleChart', Object.keys(txdata.transactionsByYear).pop(),
                        (Object.keys(txdata.transactionsByYear).pop() - 1), saleDataBefore, saleDataAfter, true)

                    drawChart('#profitChart', Object.keys(txdata.transactionsByYear).pop(),
                        (Object.keys(txdata.transactionsByYear).pop() - 1), profitDataBefore, profitDataAfter, true)

                    drawChart('#taxChart', Object.keys(txdata.transactionsByYear).pop(),
                        (Object.keys(txdata.transactionsByYear).pop() - 1), taxDataBefore, taxDataAfter, true)

                    drawChart('#itemChart', Object.keys(txdata.transactionsByYear).pop(),
                        (Object.keys(txdata.transactionsByYear).pop() - 1), itemDataBefore, itemDataAfter, false)

                    $('#activityIndicator').addClass('d-none')

                    $('.yearSwitcher').on('click', function(){
                        setUpEnvironment($(this).data('year'))
                    })
                })
        })
    }

    function drawChart(canvasElement, chartLabelAfter, chartLabelBefore, chartDataBefore, chartDataAfter, currency){
        let barChartOptions = {}
        if ( currency == true ) {
            barChartOptions = {
                responsive              : true,
                maintainAspectRatio     : false,
                datasetFill             : false,
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            callback: function(value, index, values) {
                                if (parseInt(value) >= 1000) {
                                    return '$' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                                } else {
                                    return '$' + value;
                                }
                            }
                        }
                    }]
                }
            }
        } else {
            barChartOptions = {
                responsive              : true,
                maintainAspectRatio     : false,
                datasetFill             : false,
            }
        }


        var chartData = {
            labels  : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            datasets: [
                {
                    label               : chartLabelAfter,
                    backgroundColor     : 'rgba(60,141,188,0.9)',
                    borderColor         : 'rgba(60,141,188,0.8)',
                    pointRadius          : false,
                    pointColor          : '#3b8bba',
                    pointStrokeColor    : 'rgba(60,141,188,1)',
                    pointHighlightFill  : '#fff',
                    pointHighlightStroke: 'rgba(60,141,188,1)',
                    data                : chartDataAfter
                },
                {
                    label               : chartLabelBefore,
                    backgroundColor     : 'rgba(210, 214, 222, 1)',
                    borderColor         : 'rgba(210, 214, 222, 1)',
                    pointRadius         : false,
                    pointColor          : 'rgba(210, 214, 222, 1)',
                    pointStrokeColor    : '#c1c7d1',
                    pointHighlightFill  : '#fff',
                    pointHighlightStroke: 'rgba(220,220,220,1)',
                    data                : chartDataBefore
                },
            ]
        }

        let barChartCanvas = $(canvasElement).get(0).getContext('2d')
        let temp0 = chartData.datasets[0]
        let temp1 = chartData.datasets[1]
        chartData.datasets[0] = temp1
        chartData.datasets[1] = temp0

        let barChart = new Chart(barChartCanvas, {
            type: 'bar',
            data: chartData,
            options: barChartOptions
        })
    }

    function clearCanvas(canvasId){
        let canvas = document.getElementById(canvasId),
            canvasWidth = canvas.width, canvasHeight = canvas.height,
            ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

</script>

